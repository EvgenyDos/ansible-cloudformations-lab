---
  - name:
    hosts: "{{ vmhostip }}"
    gather_facts: false
    tasks:

      - name: Make sure that the only tasks for linux module are being called
        block:
        - shell: usermod -s /sbin/nologin {{ studentname }}

        - name: Rebooting the examinating instance
          reboot:

        - name: Downloading installer of goss
          get_url:
            url: "https://goss.rocks/install"
            dest: "/root/install"
            force: yes

        - name: Configuring Goss on the instance
          shell: "chmod +x /root/install"
          loop:
            - "chmod +x /root/install"
            - "/root/install"

        - name: Copy main config file
          copy:
            dest: /root/scriptgoss.yaml
            src: "{{ exam_tasks.rootpath }}/{{ item.selected_task_path }}/goss.yaml"
          loop: "{{ exam_tasks.topics }}"

        - name: Install Goss and run it
          shell: |
            chmod +x /root/goss-results.sh /root/goss-ssh-results.sh
            /root/goss-ssh-results.sh 
            /root/goss-results.sh

        - name: Grab the Goss results
          shell: cat /root/results.txt
          ignore_errors: True
          register: bodymailreport

        - name: Send an email with results
          mail:
            subject: "Test results"
            to: "{{ adminemailnotifications }}"
            from: "{{ adminemailnotifications }}"
            body: "{{ bodymailreport.stdout }}"

        - name: Send an email to user that cloudformation is done
          mail:
            subject: "Your exam-time has been ended."
            to: "{{ useremailnotifications }}"
            from: "{{ adminemailnotifications }}"
            body: |
              Your exam-time has been ended.
              We will check the results of exam and contact with you soon.
              Thanks for your time and have a nice day.

        - name: Time for troubleshooting before full destroy
          shell: "sleep {{ waittimebeforedestroy }}"

        # Endblock
        when: testname == "linux"

