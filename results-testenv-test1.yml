---
  - name:
    hosts: "{{ vmhostip }}"
    gather_facts: false
    tasks:

        - shell: usermod -s /sbin/nologin {{ studentname }}

        - name: Rebooting the examinating instance
          reboot:

        - name: Downloading installer of goss
          get_url:
            url: "https://goss.rocks/install"
            dest: "/root/install"
            mode: "+x"
            force: yes

        - name: Configuring Goss on the instance
          shell: "{{ item }}"
          loop:
            - "/root/install"

        - name: Create a directory for Goss configs
          file:
            path: /root/goss.d
            state: directory

        - name: Copy main config file
          copy:
            dest: "/root/goss.d/{{ item.key }}.yaml"
            src: "{{ exam_tasks.rootpath }}/{{ item.value.selected_task_path }}/goss.yaml"
          with_dict: "{{ exam_tasks.topics }}"

        - name: Copy Goss scripts
          copy:
            src: "{{ item.src }}"
            dest: "{{ item.dest }}"
            mode: "+x"
          loop:
            - { src: "files/goss-results.sh", dest: "/root/goss-results.sh" }
            - { src: "files/goss-ssh-results.sh", dest: "/root/goss-ssh-results.sh" }

        - name: Install Goss and run it
          shell: |
            /root/goss-ssh-results.sh 
            /root/goss-results.sh

        - name: Grab the Goss results
          shell: cat /root/results.txt
          ignore_errors: True
          register: bodymailreport

        - name: Send an email with results
          mail:
            subject: "Test results"
            to: "{{ adminemailnotifications }}"
            from: "{{ adminemailnotifications }}"
            body: "{{ bodymailreport.stdout }}"

        - name: Send an email to user that cloudformation is done
          mail:
            subject: "Your exam-time has been ended."
            to: "{{ useremailnotifications }}"
            from: "{{ adminemailnotifications }}"
            body: |
              Your exam-time has been ended.
              We will check the results of exam and contact with you soon.
              Thanks for your time and have a nice day.

        - name: Time for troubleshooting before full destroy
          shell: "sleep {{ waittimebeforedestroy }}"