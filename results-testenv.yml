---
  - name:
    hosts: "{{ vmhostip }}"
    gather_facts: true
    tasks:
#        command: "echo {{ postcheckpwd }} | passwd {{ studentname }} --stdin"
#      - command: "curl -fsSL https://goss.rocks/install -o /root/install"
#      - command: "chmod +rx /root/install"
#      - command: "/root/install"

      - name: Download installer of goss
        get_url:
          url: "https://goss.rocks/install"
          dest: "/root/install"
          force: yes

      - shell: "chmod +x /root/install"
      - shell: "/root/install"
#      - shell: "mkdir -p /mnt1/"

      - name: copy main config file
        copy:
          dest: /root/goss.yaml
          src: "files/goss.yaml"

      - name: copy main config file
        copy:
          dest: /root/goss-results.sh
          src: "files/goss-results.sh"

#     - shell: "/usr/local/bin/goss -g /root/goss.yaml validate --format tap"
#        ignore_errors: True
#        register: resultsoutput

#      - shell: "/usr/local/bin/goss -g /root/goss.yaml validate --format tap > results.yml"
#        ignore_errors: True
#      - shell: "/usr/local/bin/goss -g /root/goss.yaml validate --format tap > results-for-mail.yml"
#        ignore_errors: True

      - shell: echo " StrictHostKeyChecking no" >> ~/.ssh/config

      - shell: chmod +x /root/goss-results.sh

      - shell: /root/goss-results.sh
        ignore_errors: True

      - shell: cat /root/results-for-mail.yml
        register: res

      - lineinfile:
          path: /root/results-for-mail.yml
          regexp: '^ok'
          line: '<font color="green"> ok'

      - name: send an email with results
        mail:
          subject: "Test results"
          to: "{{ adminemailnotifications }}"
          from: Li9 Demo <do-not-reply@demo.li9.com>
#          body: "{{ resultsoutput.stdout }}"
          body: "{{ lookup('template', '{{ res }}') }}"

      - name: send an email  to user that cloudformation is done
        mail:
          subject: "Your Test environment is ready"
          to: "{{ useremailnotifications }}"
          from: Li9 Demo <do-not-reply@demo.li9.com>
          body: |
            Your exam-time has been ended.
            We will check the results of exam and contact with you soon.
            Thanks for your time and have a nice day.

#      - name: remove tower_host from our VM inventory
#        tower_host:
#          description: "remove VM ip from inventory"
#          name:  "{{ vmhostip }}"
#          inventory: "{{ playbookvminventoryname }}"
#          tower_verify_ssl: no
#          state: absent