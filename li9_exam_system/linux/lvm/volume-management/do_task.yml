---
- name: Include vars from external file
  include_vars: vars.yml


- name: Install LVM package
  package: 
    name: lvm2
    state: present


- name: Create needed partitions
  parted:
    unit: MiB
    device: "{{ item.phys_dev }}"
    state: present
    flags: [ lvm ]
    number: "{{ item.part_number }}"
    part_type: primary
    part_start: "{{ item.part_start }}"
    part_end: "{{ item.part_end }}"
  loop: "{{ lvm_conf }}"


- name: Create volume groups
  lvg:
    vg: "{{ item.vgname }}"
    pvs: "{{ item.phys_dev }}{{ item.part_number }}"
    pesize: "{{ item.pe_size }}m"
  loop: "{{ lvm_conf }}"


- name: Create logical volumes
  lvol:
    vg: "{{ item[0].vgname }}"
    lv: "{{ item[1].name }}"
    size: "{{item[1].size_m }}"
    active: true
  loop: "{{ lvm_conf | subelements('log_vols') }}"


- name: Create file systems
  filesystem:
    fstype: "{{ item[1].fstype }}"
    dev: "/dev/{{ item[0].vgname }}/{{ item[1].name }}"
  loop: "{{ lvm_conf | subelements('log_vols') }}"


- name: Assign labels on file systems
  shell: |
    {% if item[1].fstype|lower == "ext4" %}
      tune2fs -L {{ item[1].label }} /dev/{{ item[0].vgname }}/{{ item[1].name }}
    {% elif item[1].fstype|lower == "xfs" %}
      xfs_admin -L {{ item[1].label }} /dev/{{ item[0].vgname }}/{{ item[1].name }}
    {% else %}
      echo "Unknown type of file system ({{ item[1].fstype }}) on /dev/{{ item[0].vgname }}/{{ item[1].name }}"
      exit 1
    {% endif %}
  loop: "{{ lvm_conf | subelements('log_vols') }}"
  register: labeling_status


- name: Check that labeling is done correctly
  assert:
    that: labeling_status is changed
    fail_msg: "Labeling failed: {{ labeling_status }}"
    success_msg: "Labeling done successfully"


- name: Mount file systems
  mount:
    path: "{{ item[1].mount_point }}"
    src: "/dev/{{ item[0].vgname }}/{{ item[1].name }}"
    fstype: "{{ item[1].fstype }}"
    opts: "{{ item[1].mount_opts | default('defaults') }}"
    state: mounted
  loop: "{{ lvm_conf | subelements('log_vols') }}"

