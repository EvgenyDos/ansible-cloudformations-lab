---
#
# This module makes a call to Ansible Tower
#
- name: Get needed credentials from a vault storage
  include_vars:
    file: "files/tower-creds.vault"


- name: Check what action provided
  assert:
    that: "{{ item.test }}"
    fail_msg: "{{ item.fail_msg }}"
  loop:
    - test: tower_action is defined and tower_action in [ "job_launch", "job_schedule" ]
      fail_msg: "Action is not defined or action is not supported. Current value {{ tower_action }}"


- name: Call to Ansible Tower Job
  block:

    - name: Launch a Ansible Tower Job Template
      uri:
       url: "{{ tower_job_url }}"
       user: "{{ tower_username }}"
       password: "{{ tower_password }}"
       validate_certs: false
       method: "POST"
       body_format: "json"
       body: "{{ job_extra_vars }}"
       force_basic_auth: true
       status_code: 201

  when: tower_action in [ "job_launch", "job_schedule" ]

