- name: Checking ssh credentials
  block:

# These tasks are executed on a localhosst where sshpass must be installed in advance
#     - name: Install sshpass package
#       yum:
#         name: sshpass
#         state: present
#         use_backend: yum
#       register: sshpass_install


    - name: Make sure that needed variables are there
      assert:
        that:
          - vmhostip is defined
          - student_name is defined
          - student_pass is defined
        fail_msg: "None or some of vhost, student_name, and/or student_pass variables defined"
        success_msg: "VM credentials are there"


    - name: Get ssh password check result
      block:

      - name: Check a remote ssh password on a remote host
        shell: |
          sshpass -e ssh '{{ vmhostip }}' -o StrictHostKeyChecking=no -l '{{ student_name }}' id || false
        environment:
          SSHPASS: '{{ student_pass }}'

      - name: Set ssh_check_result_flag
        set_fact:
          check_sshpass_passed: True

      rescue:

      - name: Set ssh_check_result_flag
        set_fact:
          check_sshpass_passed: False


# These tasks are executed on a localhosst where sshpass must be installed in advance
#     - name: Uninstall sshpass
#       yum:
#         name: sshpass
#         state: absent
#         use_backend: yum
#       when: sshpass_install is changed

  delegate_to: localhost

